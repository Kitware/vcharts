[
    "@defaults",
    [
        ["width", 800],
        ["height", 500]
    ],
    {
        "width": ["@value", "width"],
        "height": ["@value", "height"],
        "padding": ["@value", "padding", { "top": 10, "bottom": 50, "left": 50, "right": 150 }],
        "predicates": [
            {
                "name": "tooltip",
                "type": "==",
                "operands": [{"signal": "tooltip._id"}, {"arg": "id"}]
            }
        ],
        "data": [
            "@map",
            ["@value", "series"],
            "d",
            {
                "name": ["@value", "d.name"],
                "values": ["@value", "d.values"],
                "transform": [
                    {
                        "type": "formula",
                        "field": "x",
                        "expr": ["@value", "d.x", "datum.x"]
                    },
                    {
                        "type": "formula",
                        "field": "y",
                        "expr": ["@value","d.y", "datum.y"]
                    }
                ]
            }
        ],
        "signals": [
            {
                "name": "width", "init": ["@value", "width"]
            },
            {
                "name": "height", "init": ["@value", "height"]
            },
            {
                "name": "tooltip",
                "init": {},
                "streams": [
                    { "type": "symbol:mouseover", "expr": "datum" },
                    { "type": "symbol:mouseout", "expr": "{}" }
                ]
            },
            {
                "name": "point",
                "init": 0,
                "streams": [
                    {
                        "type": "mousedown",
                        "expr": "{x: eventX(), y: eventY()}"
                    }
                ]
            },
            {
                "name": "delta",
                "init": 0,
                "streams": [
                    {
                        "type": "[mousedown, window:mouseup] > window:mousemove",
                        "expr": "{x: point.x - eventX(), y: eventY() - point.y}"
                    }
                ]
            },
            {
                "name": "xAnchor",
                "init": 0,
                "streams": [
                    {
                        "type": "mousemove, wheel",
                        "expr": "eventX()",
                        "scale": { "name": "x", "invert": true }
                    }
                ]
            },
            {
                "name": "yAnchor",
                "init": 0,
                "streams": [
                    {
                        "type": "mousemove, wheel",
                        "expr": "eventY()",
                        "scale": {"name": "y", "invert": true}
                    }
                ]
            },
            {
                "name": "zoom",
                "init": 1.0,
                "streams": [
                    {
                        "type": "wheel",
                        "expr": "pow(1.001, event.deltaY)"
                    }
                ]
            },
            {
                "name": "xMinAnchor",
                "streams": [
                    {
                        "type": "mousedown, mouseup, wheel",
                        "expr": "0",
                        "scale": {"name": "x", "invert": true}
                    }
                ]
            },
            {
                "name": "xMaxAnchor",
                "streams": [
                    {
                        "type": "mousedown, mouseup, wheel",
                        "expr": "width",
                        "scale": {"name": "x", "invert": true}
                    }
                ]
            },
            {
                "name": "yMinAnchor",
                "streams": [
                    {
                        "type": "mousedown, mouseup, wheel",
                        "expr": "height",
                        "scale": {"name": "y", "invert": true}
                    }
                ]
            },
            {
                "name": "yMaxAnchor",
                "streams": [
                    {
                        "type": "mousedown, mouseup, wheel",
                        "expr": "0",
                        "scale": {"name": "y", "invert": true}
                    }
                ]
            },
            {
                "name": "xMin",
                "init": ["@value", "xAxis.range.0", null],
                "streams": [
                    {
                        "type": "delta",
                        "expr": [
                            "@if",
                            ["@value", "xAxis.pan", true],
                            [
                                "@if",
                                ["@eq", ["@value", "xAxis.type"], "time"],
                                "time(xMinAnchor) + (time(xMaxAnchor)-time(xMinAnchor))*delta.x/width",
                                "xMinAnchor + (xMaxAnchor-xMinAnchor)*delta.x/width"
                            ],
                            "xMinAnchor"
                        ]
                    },
                    {
                        "type": "zoom",
                        "expr": [
                            "@if",
                            ["@value", "xAxis.zoom", true],
                            [
                                "@if",
                                ["@eq", ["@value", "xAxis.type"], "time"],
                                "(time(xMinAnchor)-time(xAnchor))*zoom + time(xAnchor)",
                                "(xMinAnchor-xAnchor)*zoom + xAnchor"
                            ],
                            "xMinAnchor"
                        ]
                    }
                ]
            },
            {
                "name": "xMax",
                "init": ["@value", "xAxis.range.1", null],
                "streams": [
                    {
                        "type": "delta",
                        "expr": [
                            "@if",
                            ["@value", "xAxis.pan", true],
                            [
                                "@if",
                                ["@eq", ["@value", "xAxis.type"], "time"],
                                "time(xMaxAnchor) + (time(xMaxAnchor)-time(xMinAnchor))*delta.x/width",
                                "xMaxAnchor + (xMaxAnchor-xMinAnchor)*delta.x/width"
                            ],
                            "xMaxAnchor"
                        ]
                    },
                    {
                        "type": "zoom",
                        "expr": [
                            "@if",
                            ["@value", "xAxis.zoom", true],
                            [
                                "@if",
                                ["@eq", ["@value", "xAxis.type"], "time"],
                                "(time(xMaxAnchor)-time(xAnchor))*zoom + time(xAnchor)",
                                "(xMaxAnchor-xAnchor)*zoom + xAnchor"
                            ],
                            "xMaxAnchor"
                        ]
                    }
                ]
            },
            {
                "name": "yMin",
                "init": ["@value", "yAxis.range.0", null],
                "streams": [
                    {
                        "type": "delta",
                        "expr": [
                            "@if",
                            ["@value", "yAxis.pan", true],
                            "yMinAnchor + (yMaxAnchor-yMinAnchor)*delta.y/height",
                            "yMinAnchor"
                        ]
                    },
                    {
                        "type": "zoom",
                        "expr": [
                            "@if",
                            ["@value", "yAxis.zoom", true],
                            [
                                "@if",
                                ["@eq", ["@value", "yAxis.type"], "time"],
                                "(yMinAnchor-time(yAnchor))*zoom + time(yAnchor)",
                                "(yMinAnchor-yAnchor)*zoom + yAnchor"
                            ],
                            "yMinAnchor"
                        ]
                    }
                ]
            },
            {
                "name": "yMax",
                "init": ["@value", "yAxis.range.1", null],
                "streams": [
                    {
                        "type": "delta",
                        "expr": [
                            "@if",
                            ["@value", "yAxis.pan", true],
                            "yMaxAnchor + (yMaxAnchor-yMinAnchor)*delta.y/height",
                            "yMaxAnchor"
                        ]
                    },
                    {
                        "type": "zoom",
                        "expr": [
                            "@if",
                            ["@value", "yAxis.zoom", true],
                            [
                                "@if",
                                ["@eq", ["@value", "yAxis.type"], "time"],
                                "(yMaxAnchor-time(yAnchor))*zoom + time(yAnchor)",
                                "(yMaxAnchor-yAnchor)*zoom + yAnchor"
                            ],
                            "yMaxAnchor"
                        ]
                    }
                ]
            }
        ],
        "scales": [
            {
                "name": "x",
                "type": ["@value", "xAxis.type", "linear"],
                "range": "width",
                "zero": false,
                "domain": [
                    "@if",
                    ["@value", "series.0"],
                    {
                        "data": ["@value", "series.0.name"],
                        "field": "x"
                    },
                    [0, 1]
                ],
                "domainMin": {"signal": "xMin"},
                "domainMax": {"signal": "xMax"}
            },
            {
                "name": "y",
                "type": ["@value", "yAxis.type", "linear"],
                "range": "height",
                "zero": false,
                "domain": [
                    "@if",
                    ["@value", "series.0"],
                    {
                        "data": ["@value", "series.0.name"],
                        "field": "y"
                    },
                    [0, 1]
                ],
                "domainMin": {"signal": "yMin"},
                "domainMax": {"signal": "yMax"}
            },
            {
                "name": "color",
                "type": "ordinal",
                "domain": [
                    "@map",
                    ["@value", "series"],
                    "d",
                    ["@value", "d.name"]
                ],
                "range": [
                    "@map",
                    ["@value", "series"],
                    "d",
                    ["@value", "d.color", "steelblue"]
                ]
            }
        ],
        "axes": [
            {
                "type": "x",
                "scale": "x",
                "grid": true,
                "layer": "back",
                "title": ["@value", "xAxis.title", ""]
            },
            {
                "type": "y",
                "scale": "y",
                "grid": true,
                "layer": "back",
                "title": ["@value", "yAxis.title", ""]
            }
        ],
        "legends": [
            {
                "fill": "color",
                "orient": "right",
                "properties": {
                    "symbols": {
                        "stroke": { "value": "transparent" }
                    }
                }
            }
        ],
        "marks": [
            {
                "type": "group",
                "properties": {
                    "enter": {
                        "x": { "value": 0 },
                        "width": { "field": {"group": "width" } },
                        "y": { "value": 0 },
                        "height": { "field": { "group": "height" } },
                        "clip": { "value": true }
                    }
                },
                "marks": [
                    {
                        "type": "group",
                        "marks": [
                            "@map",
                            ["@value", "series"],
                            "d",
                            [
                                "@if",
                                ["@value", "d.line", false],
                                {
                                    "type": "line",
                                    "from": {"data": ["@value", "d.name"]},
                                    "properties": {
                                        "update": {
                                            "x": {"scale": "x", "field": "x"},
                                            "y": {"scale": "y", "field": "y"},
                                            "stroke": {"scale": "color", "value": ["@value", "d.name"]},
                                            "strokeWidth": ["@value", "d.lineWidth", 1]
                                        }
                                    }
                                },
                                null
                            ]
                        ]
                    },
                    {
                        "type": "group",
                        "marks": [
                            "@map",
                            ["@value", "series"],
                            "d",
                            [
                                "@if",
                                ["@value", "d.point", true],
                                {
                                    "type": "symbol",
                                    "from": {"data": ["@value", "d.name"]},
                                    "properties": {
                                        "update": {
                                            "x": {"scale": "x", "field": "x"},
                                            "y": {"scale": "y", "field": "y"},
                                            "fill": {"scale": "color", "value": ["@value", "d.name"]},
                                            "stroke": {"value": "#444"},
                                            "shape": {"value": ["@value", "d.shape", "circle"]},
                                            "strokeWidth": {"value": ["@value", "d.strokeWidth", 0.25]},
                                            "size": {"value": ["@value", "d.pointSize", 20]}
                                        },
                                        "hover": {
                                            "size": {"value": 80}
                                        }
                                    }
                                },
                                null
                            ]
                        ]
                    },
                    {
                        "type": "text",
                        "properties": {
                            "enter": {
                                "align": {"value": "center"},
                                "fill": {"value": "#333"}
                            },
                            "update": {
                                "x": {"scale": "x", "signal": "tooltip.x"},
                                "y": {"scale": "y", "signal": "tooltip.y", "offset": -10},
                                "text": {"template": ["@value", "tooltip", "({{tooltip.x|number:'.4g'}}, {{tooltip.y|number:'.4g'}})"]},
                                "fillOpacity": {
                                    "rule": [
                                        {
                                            "predicate": {
                                                "name": "tooltip",
                                                "id": {"value": null}
                                            },
                                            "value": 0
                                        },
                                        {"value": 1}
                                    ]
                                }
                            }
                        }
                    }
                ]
            }
        ]
    }
]
